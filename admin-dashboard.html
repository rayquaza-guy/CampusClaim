<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>CampusClaim — Admin Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/navbar.css">
  <link rel="stylesheet" href="css/components.css">
  <link rel="stylesheet" href="css/util.css">
  <link rel="stylesheet" href="css/admin.css">
  <link rel="stylesheet" href="css/admin-dashboard.css">

  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
</head>

<body>

  <nav class="topbar">
    <div class="brand">CampusClaim — Admin</div>
    <div class="nav-actions">
      <a href="admin-claims.html" class="linkbtn">Claims</a>
      <a href="admin-archive.html" class="linkbtn">Archive</a>
      <button id="logoutBtn" class="primary">Exit Admin</button>
    </div>
  </nav>

  <main class="container admin-container">

    <h2>Registry — Log Found Item</h2>

    <div class="card-panel">

      <div class="form-row">
  <input id="itemTitle" class="input wide" placeholder="Title (e.g., Black backpack)">
  <select id="itemType" class="input">
    <option value="Bag">Bag</option>
    <option value="Jewellery">Jewellery</option>
    <option value="Electronics">Electronics</option>
    <option value="ID Card">ID Card</option>
    <option value="Documents">Documents</option>
    <option value="Other">Other</option>
  </select>
</div>

      <div style="display:flex;gap:8px;margin-bottom:8px">
        <select id="itemLocation" class="input">
          <option value="A block">A block</option>
          <option value="B block">B block</option>
          <option value="C block">C block</option>
          <option value="Library">Library</option>
          <option value="TAN">TAN</option>
          <option value="Activity Space">Activity Space</option>
          <option value="Misc">Misc</option>
        </select>

        <!-- FIXED FILE INPUT -->
        <label class="file-btn">
          Upload Image
          <input id="itemThumbnail" type="file" accept="image/*" hidden>
        </label>

      </div>

      <textarea id="itemDesc" class="input" placeholder="Minimal description (optional)"></textarea>

      <div style="margin-top:8px">
        <button id="registerItem" class="primary">Register Item</button>
        <span id="regStatus"></span>
      </div>
    </div>

    <div class="card-panel">
      <h3>Recently Registered</h3>
      <div id="recentList">Loading...</div>
    </div>

  </main>

  <script src="firebase.js"></script>

  <script>

    firebase.auth().onAuthStateChanged(async user => {
      if (!user) return location.href = "admin-login.html";

      const adminDoc = await firebase.firestore()
        .collection("admins")
        .doc(user.uid)
        .get();

      if (!adminDoc.exists || adminDoc.data().isAdmin !== true) {
        alert("You are not an admin");
        location.href = "index.html";
      }
    });

    const db = firebase.firestore();
    const storage = firebase.storage();

    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('campusclaim_admin');
      location.href = 'index.html';
    });

    document.getElementById('registerItem').addEventListener('click', async () => {
      const title = itemTitle.value.trim();
      const type = itemType.value;
      const location = itemLocation.value;
      const desc = itemDesc.value.trim();
      const file = itemThumbnail.files[0];
      const statusEl = document.getElementById('regStatus');

      if (!title) { statusEl.innerText = "Title required"; return; }

      statusEl.innerText = "Registering...";

      try {
        let thumbnailURL = "";

        if (file) {
          const path = `items/${Date.now()}-${file.name}`;
          const ref = storage.ref().child(path);
          await ref.put(file);
          thumbnailURL = await ref.getDownloadURL();
        }

        // FIXED: CREATE NEW ITEM (NOT ARCHIVE)
        await db.collection("items").add({
          title,
          type,
          location,
          description: desc,
          thumbnail: thumbnailURL,
          status: "unclaimed",
          archived: false,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        statusEl.innerText = "Item Registered ✔";

        itemTitle.value = "";
        itemDesc.value = "";
        itemThumbnail.value = "";

      } catch (err) {
        console.error(err);
        statusEl.innerText = "Register failed";
      }
    });

    db.collection("items")
      .orderBy("createdAt", "desc")
      .limit(10)
      .onSnapshot(snap => {
        const list = document.getElementById("recentList");
        list.innerHTML = "";

        snap.docs.forEach(d => {
          const item = d.data();

          const row = document.createElement("div");
          row.className = "recent-item";

          row.innerHTML = `
            <strong>${item.title}</strong> — ${item.location} • ${item.type}
            <div>${item.description || ""}</div>
          `;

          const btn = document.createElement("button");
          btn.className = "archive-btn";
          btn.textContent = "Archive";

          btn.onclick = async () => {
            if (!confirm("Archive item?")) return;

            await db.collection("items").doc(d.id).update({
              archived: true,
              status: "archived",
              archivedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          };

          row.appendChild(btn);
          list.appendChild(row);
        });
      });
  </script>

</body>
</html>

