<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Admin — Claims</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="/css/base.css">
<link rel="stylesheet" href="/css/navbar.css">
<link rel="stylesheet" href="/css/components.css">
<link rel="stylesheet" href="/css/util.css">

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
</head>

<body>

  <nav class="topbar">
    <div class="brand">CampusClaim — Admin</div>
    <div class="nav-actions">
      <a href="admin-dashboard.html" class="linkbtn">Dashboard</a>
      <a href="admin-archive.html" class="linkbtn">Archive</a>
    </div>
  </nav>

  <main class="container">
    <h2>Claims awaiting review</h2>
    <div class="card-panel" id="claimsPanel">Loading...</div>
  </main>

  <script src="firebase.js"></script>

  <script>
    const db = firebase.firestore();

    // Authenticate admin
    firebase.auth().onAuthStateChanged(async (user) => {
      if (!user) {
        alert("Admin login required");
        location.href = "admin-login.html";
        return;
      }

      const adminDoc = await db.collection("admins").doc(user.uid).get();

      if (!adminDoc.exists || adminDoc.data().isAdmin !== true) {
        alert("You are not an admin");
        location.href = "index.html";
        return;
      }

      loadPendingClaims();
    });

    function loadPendingClaims() {
      db.collection('claims')
        .where('status', '==', 'pending')
        // FIX: removed orderBy that was breaking permissions
        .onSnapshot(snap => {
          const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          renderClaims(list);
        }, err => {
          console.error("Snapshot error:", err);
          document.getElementById('claimsPanel').innerHTML =
            "<small>Error loading claims (check permissions)</small>";
        });
    }

    function renderClaims(list) {
      const el = document.getElementById('claimsPanel');
      el.innerHTML = '';

      if (!list.length) {
        el.innerHTML = '<small>No pending claims</small>';
        return;
      }

      list.forEach(c => {
        const row = document.createElement('div');
        row.style.border = '1px solid #eee';
        row.style.padding = '10px';
        row.style.marginBottom = '8px';

        const dateText = c.createdAt?.toDate
          ? new Date(c.createdAt.toDate()).toLocaleString()
          : 'No timestamp';

        row.innerHTML = `
          <strong>Item ID: ${c.itemId}</strong>
          — Claimed by: ${c.claimantEmail}
          • ${dateText}
          <div style="margin-top:8px">${c.description || ''}</div>
        `;

        if (c.evidenceImages?.length) {
          const img = document.createElement('img');
          img.src = c.evidenceImages[0];
          img.style.maxWidth = '200px';
          img.style.display = 'block';
          img.style.marginTop = '8px';
          row.appendChild(img);
        }

        const approve = document.createElement('button');
        approve.textContent = 'Approve';
        approve.className = 'primary';
        approve.onclick = async () => {
          await db.collection('claims').doc(c.id).update({
            status: 'approved',
            adminMessage: 'Approved. Collect from admin office'
          });

          await db.collection('items').doc(c.itemId).update({
            status: 'claimed',
            claimedBy: c.claimantEmail,
            claimedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        };

        const reject = document.createElement('button');
        reject.textContent = 'Reject';
        reject.style.marginLeft = '8px';
        reject.onclick = async () => {
          const reason = prompt('Reason for rejection');
          await db.collection('claims').doc(c.id).update({
            status: 'rejected',
            adminMessage: reason || 'Rejected'
          });
        };

        const moreInfo = document.createElement('button');
        moreInfo.textContent = 'Request more evidence';
        moreInfo.style.marginLeft = '8px';
        moreInfo.onclick = async () => {
          const note = prompt('What evidence is required?');
          await db.collection('claims').doc(c.id).update({
            status: 'more_info',
            adminMessage: note || 'Please provide more information'
          });
        };

        const viewItem = document.createElement('button');
        viewItem.textContent = 'View item';
        viewItem.style.marginLeft = '8px';
        viewItem.onclick = () => location.href = `item.html?id=${c.itemId}`;

        row.appendChild(approve);
        row.appendChild(reject);
        row.appendChild(moreInfo);
        row.appendChild(viewItem);

        el.appendChild(row);
      });
    }
  </script>

</body>
</html>
