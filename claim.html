<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>CampusClaim — Submit Claim</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/navbar.css">
  <link rel="stylesheet" href="css/claims(claim).css">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
</head>

<body>

  <!-- NAVBAR -->
  <nav class="topbar">
    <div class="brand">CampusClaim</div>
    <div class="nav-actions">
      <a class="linkbtn" href="dashboard.html">Dashboard</a>
      <a class="linkbtn" href="inventory.html">Inventory</a>
    </div>
  </nav>

  <main class="claim-wrapper">

    <button class="back-btn" onclick="history.back()">← Back</button>

    <!-- ITEM SUMMARY -->
    <div id="itemSummary" class="item-summary">Loading item…</div>

    <!-- CLAIM CARD -->
    <div class="claim-card">
      <h2>Submit Claim</h2>

      <label>Description of proof *</label>
      <textarea id="desc" placeholder="Explain how you can verify the item is yours."></textarea>

      <label>Where did you lose it?</label>
      <select id="lostLoc">
        <option value="A block">A block</option>
        <option value="B block">B block</option>
        <option value="C block">C block</option>
        <option value="D block">D block</option>
        <option value="E block">E block</option>
        <option value="F block">F block</option>
        <option value="G block">G block</option>
        <option value="H block">H block</option>
        <option value="Library">Library</option>
        <option value="TAN">TAN</option>
        <option value="Activity Space">Activity Space</option>
        <option value="Misc">Misc</option>
      </select>

      <label>Upload evidence (optional images)</label>
      <input id="evidence" type="file" accept="image/*" multiple>

      <label class="reward-row">
        <input type="checkbox" id="rewardBox" style="display:none">
      </label>

      <button id="submitClaim" class="primary">Submit Claim</button>

      <p id="status" class="status-text"></p>
    </div>

  </main>

  <script src="firebase.js"></script>

<script>
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

const params = new URLSearchParams(location.search);
const itemId = params.get("id");

// ==========================
// LOAD ITEM PREVIEW
// ==========================
async function loadItem() {
  const doc = await db.collection("items").doc(itemId).get();
  if (!doc.exists) {
    document.getElementById("itemSummary").innerHTML = "<p>Item not found.</p>";
    return;
  }

  const data = doc.data();

  document.getElementById("itemSummary").innerHTML = `
    <div class="summary-box">
      <img src="${data.thumbnail || 'images/default.png'}" class="summary-img" />
      <div>
        <h3>${data.title}</h3>
        <div class="tags">
          <span class="tag">${data.type}</span>
          <span class="tag">${data.location}</span>
        </div>
      </div>
    </div>
  `;
}

auth.onAuthStateChanged(async user => {
  if (!user || !user.email.endsWith("@thapar.edu")) {
    alert("Login required.");
    location.href = "index.html";
    return;
  }

  await loadItem();
});

// ==========================
// IMAGE COMPRESSION FUNCTION
// ==========================
function compressImage(file, maxSize = 1024) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    const reader = new FileReader();

    reader.onload = e => { img.src = e.target.result };
    reader.onerror = reject;
    reader.readAsDataURL(file);

    img.onload = () => {
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");

      let width = img.width;
      let height = img.height;

      if (width > height) {
        if (width > maxSize) {
          height *= maxSize / width;
          width = maxSize;
        }
      } else {
        if (height > maxSize) {
          width *= maxSize / height;
          height = maxSize;
        }
      }

      canvas.width = width;
      canvas.height = height;
      ctx.drawImage(img, 0, 0, width, height);

      canvas.toBlob(
        blob => resolve(new File([blob], file.name, { type: file.type })),
        file.type,
        0.8
      );
    };
  });
}

// ==========================
// SUBMIT CLAIM
// ==========================
document.getElementById("submitClaim").addEventListener("click", async () => {
  const user = auth.currentUser;
  if (!user) return;

  const desc = document.getElementById("desc").value.trim();
  const lostLoc = document.getElementById("lostLoc").value;
  const reward = document.getElementById("rewardBox").checked;
  const files = document.getElementById("evidence").files;
  const statusEl = document.getElementById("status");

  if (!desc) {
    statusEl.innerText = "Description is required.";
    return;
  }

  statusEl.innerText = "Submitting claim...";

  let uploadedImages = [];

  // Upload images with compression + progress
  for (const file of files) {
    statusEl.innerText = "Compressing image...";
    const compressed = await compressImage(file);

    const path = `claims/${user.uid}/${Date.now()}-${file.name}`;
    const storageRef = storage.ref().child(path);
    const uploadTask = storageRef.put(compressed, { contentType: compressed.type });

    await new Promise((resolve, reject) => {
      uploadTask.on(
        "state_changed",
        snap => {
          const percent = ((snap.bytesTransferred / snap.totalBytes) * 100).toFixed(0);
          statusEl.innerText = `Uploading (${percent}%)...`;
        },
        reject,
        async () => {
          uploadedImages.push(await uploadTask.snapshot.ref.getDownloadURL());
          resolve();
        }
      );
    });
  }

  // Store claim
  await db.collection("claims").add({
    itemId,
    claimantUid: user.uid,
    claimantEmail: user.email,
    description: desc,
    lostLocation: lostLoc,
    reward,
    evidenceImages: uploadedImages,
    status: "pending",
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    adminMessage: ""
  });

  statusEl.innerText = "Claim submitted!";
  setTimeout(() => location.href = "claim-status.html", 1000);
});
</script>

</body>
</html>

